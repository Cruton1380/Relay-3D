<!DOCTYPE html>
<html>
<head>
    <title>D0 Gate Test Runner</title>
    <style>
        body {
            font-family: 'Consolas', 'Monaco', monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #4ec9b0;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.running {
            background: #264f78;
            color: #9cdcfe;
        }
        .status.pass {
            background: #0e639c;
            color: #4fc1ff;
        }
        .status.fail {
            background: #5a1d1d;
            color: #f48771;
        }
        .results {
            background: #252526;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            border: 1px solid #3e3e42;
        }
        .gate-result {
            margin: 8px 0;
            padding: 8px;
            background: #1e1e1e;
            border-left: 3px solid #007acc;
        }
        .gate-result.pass {
            border-left-color: #4ec9b0;
        }
        .gate-result.fail {
            border-left-color: #f48771;
        }
        .gate-result.inconclusive {
            border-left-color: #dcdcaa;
        }
        pre {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            border: 1px solid #3e3e42;
        }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
        }
        button:hover {
            background: #1177bb;
        }
        button:disabled {
            background: #3e3e42;
            cursor: not-allowed;
        }
        .console-log {
            background: #1e1e1e;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #3e3e42;
            font-size: 12px;
        }
        .console-log .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }
        .console-log .log-entry.d0 {
            color: #4fc1ff;
        }
        .console-log .log-entry.fps {
            color: #dcdcaa;
        }
        .console-log .log-entry.error {
            color: #f48771;
        }
        iframe {
            width: 100%;
            height: 600px;
            border: 2px solid #3e3e42;
            border-radius: 4px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî¨ Relay D0 Gate Validator</h1>
        
        <div class="status running" id="status">
            ‚è≥ Loading Relay app in iframe...
        </div>

        <button id="runTest" onclick="runD0Test()" disabled>Run D0 Gate Test</button>
        
        <div class="results" id="results" style="display: none;">
            <h2>Test Results</h2>
            <div id="resultContent"></div>
        </div>

        <div class="console-log" id="consoleLog">
            <strong>Console Output:</strong>
            <div id="logEntries"></div>
        </div>

        <iframe id="relayFrame" src="http://localhost:3000/relay-cesium-world.html"></iframe>
    </div>

    <script>
        let testRunning = false;
        let testTimeout = null;
        const logs = [];

        function addLog(message, type = 'info') {
            const timestamp = new Date().toISOString().split('T')[1].slice(0, -1);
            logs.push({ timestamp, message, type });
            
            const logEntries = document.getElementById('logEntries');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logEntries.appendChild(entry);
            logEntries.scrollTop = logEntries.scrollHeight;
        }

        // Monitor iframe load
        const iframe = document.getElementById('relayFrame');
        iframe.addEventListener('load', () => {
            addLog('Iframe loaded, waiting for app initialization...');
            
            // Wait for app to be ready
            setTimeout(() => {
                try {
                    const relayWindow = iframe.contentWindow;
                    if (relayWindow.relayD0Gate) {
                        document.getElementById('status').textContent = '‚úÖ Relay app loaded and ready';
                        document.getElementById('status').className = 'status pass';
                        document.getElementById('runTest').disabled = false;
                        addLog('relayD0Gate function detected - ready to test');
                    } else {
                        document.getElementById('status').textContent = '‚ö†Ô∏è App loaded but relayD0Gate not found';
                        document.getElementById('status').className = 'status fail';
                        addLog('ERROR: relayD0Gate function not found', 'error');
                    }
                } catch (err) {
                    document.getElementById('status').textContent = '‚ùå Cannot access iframe content (CORS?)';
                    document.getElementById('status').className = 'status fail';
                    addLog(`ERROR: ${err.message}`, 'error');
                }
            }, 3000);
        });

        async function runD0Test() {
            if (testRunning) return;
            
            testRunning = true;
            document.getElementById('runTest').disabled = true;
            document.getElementById('status').textContent = '‚è≥ Running D0 gate test...';
            document.getElementById('status').className = 'status running';
            document.getElementById('results').style.display = 'none';
            
            addLog('Starting D0 gate test with 10000 rows...', 'd0');

            try {
                const relayWindow = iframe.contentWindow;
                
                // Set timeout to detect hangs
                const HANG_TIMEOUT = 25000; // 25 seconds
                let timedOut = false;
                
                testTimeout = setTimeout(() => {
                    timedOut = true;
                    addLog('‚ö†Ô∏è TEST TIMEOUT: Test exceeded 25 seconds (likely hung at FPS measurement)', 'error');
                    document.getElementById('status').textContent = '‚ö†Ô∏è Test timed out (>25s)';
                    document.getElementById('status').className = 'status fail';
                    testRunning = false;
                    document.getElementById('runTest').disabled = false;
                }, HANG_TIMEOUT);

                // Intercept console logs from iframe
                const originalLog = relayWindow.console.log;
                const originalInfo = relayWindow.console.info;
                const originalWarn = relayWindow.console.warn;
                
                relayWindow.console.log = function(...args) {
                    originalLog.apply(relayWindow.console, args);
                    const msg = args.join(' ');
                    if (msg.includes('D0') || msg.includes('FPS')) {
                        addLog(msg, msg.includes('FPS') ? 'fps' : 'd0');
                    }
                };
                
                relayWindow.console.info = function(...args) {
                    originalInfo.apply(relayWindow.console, args);
                    const msg = args.join(' ');
                    if (msg.includes('D0') || msg.includes('FPS')) {
                        addLog(msg, msg.includes('FPS') ? 'fps' : 'd0');
                    }
                };

                relayWindow.console.warn = function(...args) {
                    originalWarn.apply(relayWindow.console, args);
                    addLog('WARN: ' + args.join(' '), 'error');
                };

                // Run the test
                const startTime = performance.now();
                const result = await relayWindow.relayD0Gate(10000);
                const elapsed = performance.now() - startTime;
                
                clearTimeout(testTimeout);
                
                if (timedOut) return;

                addLog(`Test completed in ${(elapsed / 1000).toFixed(1)}s`, 'd0');

                // Extract key results
                const output = {
                    allPass: result.allPass,
                    d03fps: result.gates['D0.3-FPS'],
                    d02: result.gates['D0.2'],
                    d04: result.gates['D0.4'],
                    elapsed: elapsed
                };

                // Display results
                displayResults(result, output);

                // Update status
                if (result.allPass) {
                    document.getElementById('status').textContent = '‚úÖ ALL GATES PASSED';
                    document.getElementById('status').className = 'status pass';
                } else {
                    document.getElementById('status').textContent = '‚ùå SOME GATES FAILED';
                    document.getElementById('status').className = 'status fail';
                }

            } catch (err) {
                clearTimeout(testTimeout);
                addLog(`ERROR: ${err.message}`, 'error');
                addLog(`Stack: ${err.stack}`, 'error');
                document.getElementById('status').textContent = '‚ùå Test failed with error';
                document.getElementById('status').className = 'status fail';
                
                const resultContent = document.getElementById('resultContent');
                resultContent.innerHTML = `<div class="gate-result fail">
                    <strong>Error:</strong> ${err.message}
                </div>`;
                document.getElementById('results').style.display = 'block';
            } finally {
                testRunning = false;
                document.getElementById('runTest').disabled = false;
            }
        }

        function displayResults(fullResult, summary) {
            const resultContent = document.getElementById('resultContent');
            
            let html = '<h3>Summary</h3>';
            html += `<pre>${JSON.stringify(summary, null, 2)}</pre>`;
            
            html += '<h3>All Gates</h3>';
            
            for (const [key, gate] of Object.entries(fullResult.gates)) {
                const status = gate.pass ? 'pass' : (key === 'D0.3-FPS' && gate.detail?.includes('INCONCLUSIVE') ? 'inconclusive' : 'fail');
                const statusText = gate.pass ? 'PASS' : (status === 'inconclusive' ? 'INCONCLUSIVE' : 'REFUSAL');
                
                html += `<div class="gate-result ${status}">
                    <strong>${key}</strong>: ${statusText}<br>
                    <small>${gate.name}</small><br>
                    <code>${gate.detail}</code>
                </div>`;
            }
            
            resultContent.innerHTML = html;
            document.getElementById('results').style.display = 'block';
        }

        // Initial log
        addLog('Test runner initialized');
    </script>
</body>
</html>
