<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relay Filament Spreadsheet - Canonical Model Prototype</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #0a0e14;
            color: #e0e0e0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #1a1f2e;
            border-bottom: 2px solid #00ff88;
            padding: 1rem 2rem;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #00ff88;
        }

        .header .status {
            font-size: 0.875rem;
            color: #888;
            margin-top: 0.25rem;
        }

        .status .canonical {
            color: #00ff88;
            font-weight: 600;
        }

        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 300px;
            background: #1a1f2e;
            border-right: 1px solid #2a2f3e;
            padding: 1.5rem;
            overflow-y: auto;
        }

        .sidebar h2 {
            font-size: 1rem;
            color: #00ff88;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .enforcement-item {
            background: #0f1419;
            border: 1px solid #2a2f3e;
            border-radius: 4px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .enforcement-item.active {
            border-color: #00ff88;
        }

        .enforcement-item h3 {
            font-size: 0.875rem;
            color: #fff;
            margin-bottom: 0.5rem;
        }

        .enforcement-item .status {
            font-size: 0.75rem;
            color: #888;
        }

        .enforcement-item .status.pass {
            color: #00ff88;
        }

        .enforcement-item .status.fail {
            color: #ff4444;
        }

        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .drop-zone {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px dashed #2a2f3e;
            margin: 2rem;
            border-radius: 8px;
            background: #0f1419;
            transition: all 0.3s ease;
        }

        .drop-zone.dragover {
            border-color: #00ff88;
            background: #1a1f2e;
        }

        .drop-zone-content {
            text-align: center;
            padding: 2rem;
        }

        .drop-zone-content .icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .drop-zone-content h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: #fff;
        }

        .drop-zone-content p {
            color: #888;
            margin-bottom: 1rem;
        }

        .spreadsheet-container {
            display: none;
            flex: 1;
            flex-direction: column;
            padding: 1rem;
            overflow: hidden;
            position: relative;
        }

        .spreadsheet-container.active {
            display: flex;
        }
        
        .view-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .toolbar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background: #1a1f2e;
            border-radius: 4px;
            align-items: center;
        }

        .view-toggle {
            display: flex;
            gap: 0.5rem;
            margin-left: auto;
        }

        .view-toggle .btn {
            padding: 0.5rem 1rem;
        }

        .view-toggle .btn.active {
            background: #00ff88;
            color: #0a0e14;
        }

        .canvas-container {
            position: absolute;
            inset: 0;
            background: #000;
            z-index: 5;
            display: none;
        }

        .canvas-container.active {
            display: block;
        }
        
        .canvas-container canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .canvas-controls {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(26, 31, 46, 0.95);
            border: 1px solid #2a2f3e;
            border-radius: 4px;
            padding: 1rem;
            z-index: 10;
        }

        .canvas-controls h3 {
            font-size: 0.875rem;
            color: #00ff88;
            margin-bottom: 0.5rem;
        }

        .canvas-controls label {
            display: block;
            font-size: 0.75rem;
            color: #888;
            margin-bottom: 0.25rem;
        }

        .canvas-controls input[type="range"] {
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            background: #2a2f3e;
            border: 1px solid #3a3f4e;
            color: #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .btn:hover:not(:disabled) {
            background: #3a3f4e;
            border-color: #00ff88;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn.primary {
            background: #00ff88;
            color: #0a0e14;
            border-color: #00ff88;
        }

        .btn.primary:hover:not(:disabled) {
            background: #00dd77;
        }

        .grid-container {
            position: absolute;
            inset: 0;
            overflow: auto;
            background: #0f1419;
            border: 1px solid #2a2f3e;
            border-radius: 4px;
            z-index: 10;
        }
        
        .grid-container.hidden {
            display: none;
        }

        .grid {
            display: grid;
            grid-template-columns: 50px repeat(10, minmax(120px, 1fr));
        }

        .cell {
            border: 1px solid #2a2f3e;
            padding: 0.5rem;
            font-size: 0.875rem;
            position: relative;
        }

        .cell.header {
            background: #1a1f2e;
            font-weight: 600;
            text-align: center;
            color: #00ff88;
        }

        .cell.row-header {
            background: #1a1f2e;
            text-align: center;
            color: #888;
        }

        .cell.editable {
            cursor: pointer;
            background: #0f1419;
        }

        .cell.editable:hover {
            background: #1a1f2e;
        }

        .cell.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .cell.disabled:hover {
            background: #0f1419;
        }

        .cell .eri-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .cell .eri-badge.high {
            background: #00ff88;
        }

        .cell .eri-badge.medium {
            background: #ffaa00;
        }

        .cell .eri-badge.low {
            background: #ff4444;
        }

        .cell .lock-icon {
            position: absolute;
            top: 4px;
            left: 4px;
            font-size: 0.75rem;
            opacity: 0.5;
        }

        .inspector {
            position: fixed;
            right: 2rem;
            top: 50%;
            transform: translateY(-50%);
            width: 350px;
            background: #1a1f2e;
            border: 1px solid #2a2f3e;
            border-radius: 8px;
            padding: 1.5rem;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
        }

        .inspector.active {
            display: block;
        }

        .inspector h2 {
            font-size: 1.125rem;
            margin-bottom: 1rem;
            color: #00ff88;
        }

        .inspector .section {
            margin-bottom: 1.5rem;
        }

        .inspector .section h3 {
            font-size: 0.875rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .inspector .section .value {
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .inspector .commit-log {
            max-height: 200px;
            overflow-y: auto;
            background: #0f1419;
            border: 1px solid #2a2f3e;
            border-radius: 4px;
            padding: 0.75rem;
        }

        .inspector .commit-item {
            font-size: 0.75rem;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #2a2f3e;
        }

        .inspector .commit-item:last-child {
            border-bottom: none;
        }

        .inspector .commit-item .timestamp {
            color: #888;
        }

        .refusal-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .refusal-modal.active {
            display: flex;
        }

        .refusal-content {
            background: #1a1f2e;
            border: 2px solid #ff4444;
            border-radius: 8px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
        }

        .refusal-content h2 {
            color: #ff4444;
            margin-bottom: 1rem;
        }

        .refusal-content .reasons {
            margin: 1rem 0;
        }

        .refusal-content .reason {
            background: #0f1419;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            border-left: 3px solid #ff4444;
        }

        .refusal-content .next-steps {
            margin-top: 1.5rem;
        }

        .refusal-content .next-steps h3 {
            color: #00ff88;
            margin-bottom: 0.5rem;
        }

        .refusal-content .next-steps ol {
            margin-left: 1.5rem;
        }

        .refusal-content .next-steps li {
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîí Relay Filament Spreadsheet</h1>
        <div class="status">
            <span class="canonical">CANONICAL MODEL</span> | 
            Commit: ee5146f | 
            Enforcement: ACTIVE
        </div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <h2>Enforcement Status</h2>
            <div class="enforcement-item active" id="sac-status">
                <h3>1. State Anchoring</h3>
                <div class="status">No SAC required (local file)</div>
            </div>
            <div class="enforcement-item" id="drift-status">
                <h3>2. Drift Detection</h3>
                <div class="status">0 open drifts</div>
            </div>
            <div class="enforcement-item" id="authority-status">
                <h3>3. Authority Decay</h3>
                <div class="status">Local authority (expires in 30m)</div>
            </div>
            <div class="enforcement-item" id="learning-status">
                <h3>4. Learning Boundary</h3>
                <div class="status">No learning active</div>
            </div>
            <div class="enforcement-item" id="refusal-status">
                <h3>5. Refusal-First UX</h3>
                <div class="status pass">‚úÖ ACTIVE</div>
            </div>
            <div class="enforcement-item" id="pressure-status">
                <h3>6. Pressure Budget</h3>
                <div class="status pass">0/10 actions used</div>
            </div>
            <div class="enforcement-item" id="eri-status">
                <h3>7. ERI Calculation</h3>
                <div class="status">Ready</div>
            </div>
            <div class="enforcement-item" id="three-way-status">
                <h3>8. Three-Way Match</h3>
                <div class="status">Ready</div>
            </div>
        </div>

        <div class="content">
            <div class="drop-zone" id="dropZone">
                <div class="drop-zone-content">
                    <div class="icon">üìä</div>
                    <h2>Drop Excel File Here</h2>
                    <p>Drag and drop an .xlsx or .csv file to launch the filament model</p>
                    <p style="font-size: 0.875rem; color: #666;">
                        Every row becomes a commit ‚Ä¢ Cells get ERI scores ‚Ä¢ Authority expires
                    </p>
                    <button class="btn primary" onclick="document.getElementById('fileInput').click()">
                        Or Click to Browse
                    </button>
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none;">
                </div>
            </div>

            <div class="spreadsheet-container" id="spreadsheetContainer">
                <div class="toolbar">
                    <button class="btn" id="forkBtn" disabled>
                        üå≥ Fork (What-If)
                    </button>
                    <button class="btn" id="commitBtn" disabled>
                        üíæ Commit Changes
                    </button>
                    <button class="btn" id="historyBtn">
                        üìú View History
                    </button>
                    
                    <div class="view-toggle">
                        <button class="btn active" id="gridViewBtn" onclick="switchView('grid')">
                            üìä Grid View
                        </button>
                        <button class="btn" id="filamentViewBtn" onclick="switchView('filament')">
                            üå≥ 3D Filament
                        </button>
                    </div>
                    
                    <button class="btn" id="newFileBtn">
                        üìÇ Load New File
                    </button>
                </div>

                <div class="view-container">
                    <div class="grid-container" id="gridView">
                        <div class="grid" id="grid"></div>
                    </div>

                    <div class="canvas-container" id="filamentView">
                        <!-- Canvas will be dynamically created and appended here -->
                        <div class="canvas-controls">
                            <h3>3D Controls</h3>
                            <label>Zoom</label>
                            <input type="range" id="zoomControl" min="5" max="50" value="20" step="1">
                            <label>Rotation Speed</label>
                            <input type="range" id="rotationControl" min="0" max="2" value="0.5" step="0.1">
                            <button class="btn" style="width: 100%; margin-top: 0.5rem;" onclick="resetCamera()">
                                Reset Camera
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="inspector" id="inspector">
        <h2>Cell Inspector</h2>
        
        <div class="section">
            <h3>Cell ID</h3>
            <div class="value" id="cellId">-</div>
        </div>

        <div class="section">
            <h3>Value</h3>
            <div class="value" id="cellValue">-</div>
        </div>

        <div class="section">
            <h3>ERI Score</h3>
            <div class="value" id="cellERI">-</div>
        </div>

        <div class="section">
            <h3>Authority</h3>
            <div class="value" id="cellAuthority">-</div>
        </div>

        <div class="section">
            <h3>Commit History</h3>
            <div class="commit-log" id="commitLog">
                <div style="color: #888;">No commits yet</div>
            </div>
        </div>

        <button class="btn primary" style="width: 100%; margin-top: 1rem;" onclick="closeInspector()">
            Close
        </button>
    </div>

    <div class="refusal-modal" id="refusalModal">
        <div class="refusal-content">
            <h2>üîí Action Refused</h2>
            <div class="reasons" id="refusalReasons"></div>
            <div class="next-steps">
                <h3>Next Steps:</h3>
                <ol id="refusalSteps"></ol>
            </div>
            <button class="btn primary" style="width: 100%; margin-top: 1.5rem;" onclick="closeRefusal()">
                Understood
            </button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Canonical Filament Spreadsheet Model - Prototype Implementation
        
        const state = {
            data: [],
            commits: [],
            forks: [], // Store forked filaments
            authority: {
                user: 'local@prototype',
                issued_at: Date.now(),
                expires_at: Date.now() + (30 * 60 * 1000), // 30 minutes
                scope: 'full'
            },
            selectedCell: null,
            driftObjects: [],
            pressureBudget: { used: 0, max: 10 }
        };

        // Drop zone handling
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) handleFile(file);
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });

        document.getElementById('newFileBtn').addEventListener('click', () => {
            document.getElementById('spreadsheetContainer').classList.remove('active');
            dropZone.style.display = 'flex';
            state.data = [];
            state.commits = [];
            state.forks = [];
        });

        document.getElementById('forkBtn').addEventListener('click', () => {
            createFork();
        });

        function handleFile(file) {
            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    // Import as filament (each row = commit)
                    importAsFilament(jsonData, file.name);
                    
                } catch (error) {
                    alert('Error reading file: ' + error.message);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function importAsFilament(data, filename) {
            // Clear existing state
            state.data = [];
            state.commits = [];
            
            // Create import commit
            createCommit('IMPORT', {
                intent: `Import spreadsheet: ${filename}`,
                reality: { rows: data.length, cols: data[0]?.length || 0 },
                projection: 'All rows will become filament commits'
            });

            // Convert each row to a commit
            data.forEach((row, rowIndex) => {
                const rowData = row.map((cell, colIndex) => ({
                    value: cell || '',
                    eri: calculateERI(cell, rowIndex, colIndex),
                    authority: null // No authority yet
                }));
                
                state.data.push(rowData);
                
                // Create row commit
                createCommit('ROW_CREATE', {
                    intent: `Create row ${rowIndex + 1}`,
                    reality: { row: rowIndex, data: rowData },
                    projection: `Row ${rowIndex + 1} added to filament`
                });
            });

            // Update UI
            renderGrid();
            dropZone.style.display = 'none';
            document.getElementById('spreadsheetContainer').classList.add('active');
            
            // Enable fork button
            document.getElementById('forkBtn').disabled = false;
            
            // Update enforcement status
            updateEnforcementStatus();
            
            // Show success
            showNotification(`‚úÖ Imported ${data.length} rows as filament commits`, 'success');
        }

        function calculateERI(value, row, col) {
            // Simple ERI calculation
            let score = 50; // Base score
            
            // Visibility: does cell have content?
            if (value && value.toString().trim()) score += 20;
            
            // Configuration: is it properly formatted?
            if (typeof value === 'number' || !isNaN(parseFloat(value))) score += 10;
            
            // Patch status: is it recent? (always yes for new import)
            score += 10;
            
            // Authority: do we have authority? (not yet)
            // score += 0;
            
            // Recovery: can it be restored? (yes, it's in commits)
            score += 10;
            
            return Math.min(100, score);
        }

        function createCommit(type, data) {
            const commit = {
                id: `commit_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                type,
                timestamp: Date.now(),
                authority: state.authority,
                ...data
            };
            
            state.commits.push(commit);
            return commit;
        }

        function createFork() {
            // FIX #3: Gate fork creation with pressure budget check
            if (state.pressureBudget.used >= state.pressureBudget.max) {
                showRefusal([
                    `Pressure budget exhausted (${state.pressureBudget.used}/${state.pressureBudget.max})`,
                    'Fork creation requires available capacity'
                ], [
                    'Resolve existing drifts to free capacity',
                    'Wait for budget reset',
                    'Close unused forks'
                ]);
                return;
            }
            
            // FIX #3: Fork creation modal for intent capture (simplified inline for now)
            const assumptions = [
                'Cost +10% (higher vendor quotes)',
                'Cost -15% (volume discount)',
                'Timeline +3mo (supply chain delay)',
                'Quality threshold +20% (stricter specs)'
            ];
            const assumption = assumptions[state.forks.length % assumptions.length];
            
            // Create fork from current main filament
            const forkPoint = Math.floor(state.commits.length * 0.5);
            const forkCommits = [];
            
            // FIX #2: Descriptive, not evaluative labels
            const forkLabel = `Scenario ${String.fromCharCode(65 + state.forks.length)}`;
            
            // Create fork divergence
            for (let i = 0; i < 50; i++) {
                forkCommits.push({
                    id: `fork_${state.forks.length}_commit_${i}`,
                    type: 'FORK_COMMIT',
                    scenario: forkLabel,
                    assumption: assumption,
                    timestamp: Date.now() + i,
                    forkIndex: state.forks.length,
                    commitIndex: i,
                    intent: `${forkLabel}: ${assumption} - projection ${i + 1}`,
                    reality: { value: Math.random() * 100 }
                });
            }
            
            // Create fork intent commit
            const forkIntentCommit = {
                id: `fork_intent_${state.forks.length}`,
                type: 'FORK_INTENT',
                intent: `Create scenario fork: ${assumption}`,
                reality: { fork_point: forkPoint, assumption: assumption },
                projection: `Explore alternative trajectory with: ${assumption}`,
                authority: state.authority,
                timestamp: Date.now()
            };
            state.commits.push(forkIntentCommit);
            
            const fork = {
                id: `fork_${state.forks.length}`,
                name: `${forkLabel} (${assumption})`, // FIX #2: Descriptive label
                branchPoint: forkPoint,
                commits: forkCommits,
                assumption: assumption,
                color: [0xff6b6b, 0xffd93d, 0x6bcf7f, 0x4d96ff][state.forks.length % 4],
                created_at: Date.now(),
                intent_commit: forkIntentCommit
            };
            
            state.forks.push(fork);
            
            // FIX #3: Consume pressure budget
            state.pressureBudget.used += 1;
            updateEnforcementStatus();
            
            // Re-render 3D if in filament view
            if (renderer) {
                render3DFilament();
            }
            
            showNotification(`‚úÖ Created fork: ${fork.name}`, 'success');
            console.log(`Fork created with assumption: ${assumption}`);
            console.log(`Pressure budget: ${state.pressureBudget.used}/${state.pressureBudget.max}`);
            
            return fork;
        }

        function renderGrid() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            
            if (state.data.length === 0) return;
            
            const cols = state.data[0].length;
            
            // Header row
            const emptyHeader = document.createElement('div');
            emptyHeader.className = 'cell header';
            grid.appendChild(emptyHeader);
            
            for (let col = 0; col < cols; col++) {
                const header = document.createElement('div');
                header.className = 'cell header';
                header.textContent = String.fromCharCode(65 + col); // A, B, C...
                grid.appendChild(header);
            }
            
            // Data rows
            state.data.forEach((row, rowIndex) => {
                // Row header
                const rowHeader = document.createElement('div');
                rowHeader.className = 'cell row-header';
                rowHeader.textContent = rowIndex + 1;
                grid.appendChild(rowHeader);
                
                // Data cells
                row.forEach((cellData, colIndex) => {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.textContent = cellData.value;
                    cell.dataset.row = rowIndex;
                    cell.dataset.col = colIndex;
                    
                    // Authority check (refusal-first UX)
                    if (!hasAuthority()) {
                        cell.classList.add('disabled');
                        cell.innerHTML = `<span class="lock-icon">üîí</span>${cellData.value}`;
                        cell.title = 'Authority expired - click for details';
                    } else {
                        cell.classList.add('editable');
                    }
                    
                    // ERI badge
                    const eriBadge = document.createElement('div');
                    eriBadge.className = 'eri-badge';
                    if (cellData.eri >= 80) eriBadge.classList.add('high');
                    else if (cellData.eri >= 50) eriBadge.classList.add('medium');
                    else eriBadge.classList.add('low');
                    eriBadge.title = `ERI: ${cellData.eri}`;
                    cell.appendChild(eriBadge);
                    
                    // Click handler
                    cell.addEventListener('click', () => handleCellClick(rowIndex, colIndex));
                    
                    grid.appendChild(cell);
                });
            });
        }

        function handleCellClick(row, col) {
            const cellData = state.data[row][col];
            
            // Check authority (enforcement!)
            if (!hasAuthority()) {
                showRefusal([
                    'Authority expired (30 minutes elapsed)',
                    'Edits require valid authority'
                ], [
                    'Renew authority (requires governance approval)',
                    'Rotate to another user',
                    'View cell in read-only mode'
                ]);
                return;
            }
            
            // Check pressure budget
            if (state.pressureBudget.used >= state.pressureBudget.max) {
                showRefusal([
                    `Pressure budget exhausted (${state.pressureBudget.used}/${state.pressureBudget.max})`,
                    'Cannot perform more actions until budget resets'
                ], [
                    'Wait for budget reset (daily)',
                    'Batch multiple edits into single commit',
                    'Request budget increase (requires justification)'
                ]);
                return;
            }
            
            // Check for open drifts
            if (state.driftObjects.length > 0) {
                showRefusal([
                    `${state.driftObjects.length} open drift object(s) block edits`,
                    'Drift must be resolved before new changes'
                ], [
                    'Resolve drift objects',
                    'Investigate mismatch source',
                    'Dismiss drift with justification (requires authority)'
                ]);
                return;
            }
            
            // Show inspector
            showInspector(row, col);
        }

        function showInspector(row, col) {
            const cellData = state.data[row][col];
            const cellId = `${String.fromCharCode(65 + col)}${row + 1}`;
            
            document.getElementById('cellId').textContent = cellId;
            document.getElementById('cellValue').textContent = cellData.value || '(empty)';
            document.getElementById('cellERI').innerHTML = `
                ${cellData.eri}/100 
                <span style="color: ${cellData.eri >= 80 ? '#00ff88' : cellData.eri >= 50 ? '#ffaa00' : '#ff4444'}">
                    ${cellData.eri >= 80 ? '‚óè' : cellData.eri >= 50 ? '‚óè' : '‚óè'}
                </span>
            `;
            
            const authExpiry = new Date(state.authority.expires_at);
            const timeLeft = Math.max(0, Math.floor((authExpiry - Date.now()) / 1000 / 60));
            document.getElementById('cellAuthority').innerHTML = `
                ${state.authority.user}<br>
                <span style="font-size: 0.875rem; color: ${timeLeft < 5 ? '#ff4444' : '#888'}">
                    Expires in ${timeLeft} minutes
                </span>
            `;
            
            // Show commits for this cell
            const cellCommits = state.commits.filter(c => 
                c.reality?.row === row || c.type === 'IMPORT'
            );
            
            const commitLog = document.getElementById('commitLog');
            if (cellCommits.length > 0) {
                commitLog.innerHTML = cellCommits.map(commit => `
                    <div class="commit-item">
                        <strong>${commit.type}</strong><br>
                        <span class="timestamp">${new Date(commit.timestamp).toLocaleString()}</span><br>
                        ${commit.intent || ''}
                    </div>
                `).join('');
            } else {
                commitLog.innerHTML = '<div style="color: #888;">No commits for this cell</div>';
            }
            
            document.getElementById('inspector').classList.add('active');
            state.selectedCell = { row, col };
        }

        function closeInspector() {
            document.getElementById('inspector').classList.remove('active');
            state.selectedCell = null;
        }

        function showRefusal(reasons, steps) {
            const reasonsDiv = document.getElementById('refusalReasons');
            reasonsDiv.innerHTML = reasons.map(r => `
                <div class="reason">‚ùå ${r}</div>
            `).join('');
            
            const stepsDiv = document.getElementById('refusalSteps');
            stepsDiv.innerHTML = steps.map(s => `<li>${s}</li>`).join('');
            
            document.getElementById('refusalModal').classList.add('active');
        }

        function closeRefusal() {
            document.getElementById('refusalModal').classList.remove('active');
        }

        function hasAuthority() {
            return Date.now() < state.authority.expires_at;
        }

        function updateEnforcementStatus() {
            document.getElementById('drift-status').querySelector('.status').textContent = 
                `${state.driftObjects.length} open drifts`;
            
            const timeLeft = Math.max(0, Math.floor((state.authority.expires_at - Date.now()) / 1000 / 60));
            document.getElementById('authority-status').querySelector('.status').textContent = 
                `Local authority (expires in ${timeLeft}m)`;
            
            document.getElementById('pressure-status').querySelector('.status').textContent = 
                `${state.pressureBudget.used}/${state.pressureBudget.max} actions used`;
            
            document.getElementById('eri-status').querySelector('.status').innerHTML = 
                '<span class="pass">‚úÖ ACTIVE</span>';
            
            document.getElementById('three-way-status').querySelector('.status').innerHTML = 
                '<span class="pass">‚úÖ ACTIVE</span>';
        }

        function showNotification(message, type) {
            // Simple notification (you can enhance this)
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // ========================================
        // 3D FILAMENT VISUALIZATION (Three.js)
        // ========================================

        let scene, camera, renderer, controls;
        let commitNodes = [];
        let filamentEdges = [];
        let animationId;

        function init3DView() {
            const container = document.getElementById('filamentView');
            
            // Scene setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000000);
            
            // Camera setup
            const width = container.clientWidth;
            const height = container.clientHeight;
            camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
            camera.position.set(0, 5, 20);
            camera.lookAt(0, 0, 0);
            
            // Renderer setup - CRITICAL: Must append to DOM
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(width, height);
            renderer.setPixelRatio(window.devicePixelRatio);
            
            // STEP 3: APPEND RENDERER TO CONTAINER (this was missing!)
            container.innerHTML = ''; // Clear any old content
            container.appendChild(renderer.domElement);
            
            // STEP 4: Add visible test sphere FIRST
            const testGeometry = new THREE.SphereGeometry(1, 32, 32);
            const testMaterial = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
            const testSphere = new THREE.Mesh(testGeometry, testMaterial);
            testSphere.position.set(0, 0, 0);
            scene.add(testSphere);
            
            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0x00ff88, 0.8);
            directionalLight.position.set(10, 10, 10);
            scene.add(directionalLight);
            
            // Grid helper
            const gridHelper = new THREE.GridHelper(40, 40, 0x00ff88, 0x2a2f3e);
            gridHelper.position.y = -5;
            scene.add(gridHelper);
            
            // Render commits as 3D filament (after test sphere)
            render3DFilament();
            
            // STEP 5: Start animation loop
            animate3D();
            
            // Window resize handler
            window.addEventListener('resize', onWindowResize);
            
            console.log('3D View Initialized - Test sphere should be visible');
        }

        function render3DFilament() {
            // Clear existing nodes/edges
            commitNodes.forEach(node => scene.remove(node));
            filamentEdges.forEach(edge => scene.remove(edge));
            commitNodes = [];
            filamentEdges = [];
            
            if (state.commits.length === 0) return;
            
            // RENDER MAIN FILAMENT (original commits)
            const mainNodes = [];
            state.commits.forEach((commit, index) => {
                // Position commits in a helix (space-time filament)
                const angle = (index / state.commits.length) * Math.PI * 4;
                const radius = 5;
                const x = Math.cos(angle) * radius;
                const z = Math.sin(angle) * radius;
                const y = (index / state.commits.length) * 15 - 7.5; // Vertical spread
                
                // Node appearance based on commit type
                let color, size;
                if (commit.type === 'IMPORT') {
                    color = 0x00ff88; // Green for import
                    size = 0.5;
                } else if (commit.type === 'ROW_CREATE') {
                    color = 0x88aaff; // Blue for row creates
                    size = 0.3;
                } else {
                    color = 0xffaa00; // Orange for other
                    size = 0.25;
                }
                
                // Create node geometry
                const geometry = new THREE.SphereGeometry(size, 16, 16);
                const material = new THREE.MeshPhongMaterial({ 
                    color: color,
                    emissive: color,
                    emissiveIntensity: 0.3,
                    shininess: 100
                });
                const node = new THREE.Mesh(geometry, material);
                node.position.set(x, y, z);
                node.userData = { commit: commit, index: index, filament: 'main' };
                
                // Add glow effect
                const glowGeometry = new THREE.SphereGeometry(size * 1.5, 16, 16);
                const glowMaterial = new THREE.MeshBasicMaterial({
                    color: color,
                    transparent: true,
                    opacity: 0.2
                });
                const glow = new THREE.Mesh(glowGeometry, glowMaterial);
                node.add(glow);
                
                scene.add(node);
                commitNodes.push(node);
                mainNodes.push(node);
                
                // Create edge to previous commit (filament strand)
                if (index > 0) {
                    const prevNode = mainNodes[index - 1];
                    const points = [];
                    points.push(prevNode.position);
                    points.push(node.position);
                    
                    const lineGeometry = new THREE.BufferGeometry().setFromPoints(points);
                    const lineMaterial = new THREE.LineBasicMaterial({ 
                        color: 0x00ff88,
                        opacity: 0.6,
                        transparent: true,
                        linewidth: 2
                    });
                    const line = new THREE.Line(lineGeometry, lineMaterial);
                    scene.add(line);
                    filamentEdges.push(line);
                }
            });
            
            // RENDER FORK FILAMENTS
            state.forks.forEach((fork, forkIndex) => {
                const branchNode = mainNodes[fork.branchPoint];
                if (!branchNode) return;
                
                const forkNodes = [];
                
                fork.commits.forEach((commit, index) => {
                    // Fork diverges from branch point with different trajectory
                    const baseAngle = (fork.branchPoint / state.commits.length) * Math.PI * 4;
                    const forkOffset = (forkIndex + 1) * Math.PI * 0.5; // Offset each fork
                    const angle = baseAngle + forkOffset + (index / fork.commits.length) * Math.PI * 2;
                    const radius = 5 + (forkIndex + 1) * 2; // Each fork has wider radius
                    const x = Math.cos(angle) * radius;
                    const z = Math.sin(angle) * radius;
                    const yStart = branchNode.position.y;
                    const y = yStart + (index / fork.commits.length) * 10; // Vertical progression
                    
                    // FIX #1: Fork nodes are TRANSLUCENT (projections, not reality)
                    const geometry = new THREE.SphereGeometry(0.25, 16, 16);
                    const material = new THREE.MeshPhongMaterial({ 
                        color: fork.color,
                        emissive: fork.color,
                        emissiveIntensity: 0.2, // FIX #1: Softer glow (was 0.4)
                        shininess: 50,          // FIX #1: Less shiny
                        transparent: true,       // FIX #1: TRANSLUCENT
                        opacity: 0.6             // FIX #1: Only canonical is fully opaque
                    });
                    const node = new THREE.Mesh(geometry, material);
                    node.position.set(x, y, z);
                    node.userData = { commit: commit, fork: fork, filament: 'fork' };
                    
                    // FIX #1: Softer glow on forks
                    const glowGeometry = new THREE.SphereGeometry(0.35, 16, 16);
                    const glowMaterial = new THREE.MeshBasicMaterial({
                        color: fork.color,
                        transparent: true,
                        opacity: 0.15  // FIX #1: Much softer than main (was 0.3)
                    });
                    const glow = new THREE.Mesh(glowGeometry, glowMaterial);
                    node.add(glow);
                    
                    scene.add(node);
                    commitNodes.push(node);
                    forkNodes.push(node);
                    
                    // Connect to previous fork node or branch point
                    if (index === 0) {
                        // FIX #1: Branch connection is dashed (projection, not reality)
                        const points = [branchNode.position.clone(), node.position];
                        const lineGeometry = new THREE.BufferGeometry().setFromPoints(points);
                        const lineMaterial = new THREE.LineDashedMaterial({ 
                            color: fork.color,
                            opacity: 0.4,          // FIX #1: More transparent
                            transparent: true,
                            linewidth: 2,          // FIX #1: Thinner
                            dashSize: 0.3,         // FIX #1: Dashed pattern
                            gapSize: 0.2
                        });
                        const line = new THREE.Line(lineGeometry, lineMaterial);
                        line.computeLineDistances(); // Required for dashed lines
                        scene.add(line);
                        filamentEdges.push(line);
                    } else {
                        // FIX #1: Fork strands are dashed/thinner
                        const prevNode = forkNodes[index - 1];
                        const points = [prevNode.position, node.position];
                        const lineGeometry = new THREE.BufferGeometry().setFromPoints(points);
                        const lineMaterial = new THREE.LineDashedMaterial({ 
                            color: fork.color,
                            opacity: 0.4,          // FIX #1: More transparent
                            transparent: true,
                            linewidth: 1,          // FIX #1: Thinner
                            dashSize: 0.2,         // FIX #1: Dashed pattern
                            gapSize: 0.15
                        });
                        const line = new THREE.Line(lineGeometry, lineMaterial);
                        line.computeLineDistances(); // Required for dashed lines
                        scene.add(line);
                        filamentEdges.push(line);
                    }
                });
                
                // Add fork label
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = 512;
                canvas.height = 128;
                context.fillStyle = '#' + fork.color.toString(16).padStart(6, '0');
                context.font = 'Bold 48px Arial';
                context.fillText(fork.name, 10, 64);
                
                const texture = new THREE.CanvasTexture(canvas);
                const spriteMaterial = new THREE.SpriteMaterial({ map: texture });
                const sprite = new THREE.Sprite(spriteMaterial);
                sprite.position.copy(forkNodes[Math.floor(forkNodes.length / 2)].position);
                sprite.position.x += 2;
                sprite.scale.set(4, 1, 1);
                scene.add(sprite);
            });
            
            // Add main filament label
            const importCommit = state.commits.find(c => c.type === 'IMPORT');
            if (importCommit) {
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = 512;
                canvas.height = 128;
                context.fillStyle = '#00ff88';
                context.font = 'Bold 48px Arial';
                context.fillText('MAIN', 10, 64);
                context.font = '32px Arial';
                context.fillText(`${state.commits.length} commits`, 10, 108);
                
                const texture = new THREE.CanvasTexture(canvas);
                const spriteMaterial = new THREE.SpriteMaterial({ map: texture });
                const sprite = new THREE.Sprite(spriteMaterial);
                sprite.position.copy(commitNodes[0].position);
                sprite.position.y += 1.5;
                sprite.scale.set(4, 1, 1);
                scene.add(sprite);
            }
            
            console.log(`Rendered: 1 main filament + ${state.forks.length} fork(s)`);
        }

        function animate3D() {
            animationId = requestAnimationFrame(animate3D);
            
            // Auto-rotate camera
            const rotationSpeed = parseFloat(document.getElementById('rotationControl')?.value || 0.5);
            if (rotationSpeed > 0) {
                const time = Date.now() * 0.0001 * rotationSpeed;
                const zoom = parseFloat(document.getElementById('zoomControl')?.value || 20);
                camera.position.x = Math.sin(time) * zoom;
                camera.position.z = Math.cos(time) * zoom;
                camera.lookAt(0, 0, 0);
            }
            
            // Pulse commit nodes
            commitNodes.forEach((node, index) => {
                const scale = 1 + Math.sin(Date.now() * 0.002 + index) * 0.1;
                node.scale.set(scale, scale, scale);
            });
            
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            const container = document.getElementById('filamentView');
            if (container && renderer) {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            }
        }

        function resetCamera() {
            camera.position.set(0, 5, 20);
            camera.lookAt(0, 0, 0);
        }

        function switchView(view) {
            const gridView = document.getElementById('gridView');
            const filamentView = document.getElementById('filamentView');
            const gridBtn = document.getElementById('gridViewBtn');
            const filamentBtn = document.getElementById('filamentViewBtn');
            
            if (view === 'grid') {
                // STEP 2: Hard toggle - show grid, hide 3D
                gridView.style.display = 'block';
                filamentView.style.display = 'none';
                filamentView.classList.remove('active');
                gridBtn.classList.add('active');
                filamentBtn.classList.remove('active');
                
                console.log('Switched to Grid View');
            } else if (view === 'filament') {
                // STEP 2: Hard toggle - hide grid, show 3D
                gridView.style.display = 'none';
                filamentView.style.display = 'block';
                filamentView.classList.add('active');
                gridBtn.classList.remove('active');
                filamentBtn.classList.add('active');
                
                console.log('Switching to Filament View...');
                
                // Initialize 3D view if not already done
                if (!renderer) {
                    console.log('Initializing 3D renderer...');
                    init3DView();
                } else {
                    console.log('Re-rendering existing 3D scene...');
                    render3DFilament();
                    onWindowResize();
                }
            }
        }

        // Initialize
        updateEnforcementStatus();
        
        // Simulate authority expiry
        setInterval(() => {
            updateEnforcementStatus();
            if (!hasAuthority() && state.data.length > 0) {
                renderGrid(); // Re-render to show locked cells
            }
        }, 10000); // Check every 10 seconds
    </script>
</body>
</html>
