/**
 * @fileoverview Authentication Routes Tests
 * @description Tests for authentication routes matching actual implementation
 * @version 1.0.0
 */

import { describe, it, expect, beforeEach, afterEach, vi } from 'vitest';
import request from 'supertest';
import express from 'express';

// Mock all dependencies before importing the routes
vi.mock('../../src/backend/auth/policies/authController.mjs', () => ({
  default: {
    login: vi.fn(),
    logout: vi.fn(),
    refreshToken: vi.fn(),  // Correct function name
    verifyAuth: vi.fn(),    // Correct function name
    elevateAuth: vi.fn()    // Correct function name
  }
}));

vi.mock('../../src/backend/auth/policies/authPolicy.mjs', () => ({
  default: {
    requireAuth: vi.fn(() => (req, res, next) => next()),
    optionalAuth: vi.fn(() => (req, res, next) => next()),
    extractToken: vi.fn(),
    AUTH_LEVELS: {
      NONE: 0,
      BASIC: 1,
      STANDARD: 2,
      ELEVATED: 3,
      ADMIN: 4
    }
  },
  AUTH_LEVELS: {
    NONE: 0,
    BASIC: 1,
    STANDARD: 2,
    ELEVATED: 3,
    ADMIN: 4
  }
}));

vi.mock('../../src/backend/utils/logging/logger.mjs', () => ({
  default: {
    child: vi.fn(() => ({
      info: vi.fn(),
      error: vi.fn(),
      warn: vi.fn(),
      debug: vi.fn()
    })),
    info: vi.fn(),
    error: vi.fn(),
    warn: vi.fn(),
    debug: vi.fn()
  }
}));

vi.mock('../../src/backend/middleware/errorHandler.mjs', () => ({
  asyncHandler: vi.fn((fn) => fn)
}));

vi.mock('../../src/backend/utils/storage/caching.mjs', () => ({
  cacheGet: vi.fn(),
  cacheSet: vi.fn()
}));

describe('Authentication Routes', () => {
  let app;
  let router;
  let routes;
  
  beforeEach(async () => {
    app = express();
    router = express.Router();

    // Reset mock implementations
    vi.clearAllMocks();

    // Import the routes module after mock setup
    routes = await import('../../src/backend/routes/auth.mjs');
    
    // Configure the router with our routes
    routes.default(router);
    
    // Attach router to app
    app.use('/auth', router);
    
    // Add error handler
    app.use((err, req, res, next) => {
      res.status(err.statusCode || 500).json({ error: err.message });
    });
  });

  describe('POST /auth/login', () => {
    it('should call the login controller and return its response', async () => {
      const mockLoginResponse = { token: 'test-token', user: { id: '123', username: 'testuser' } };
      const mockAuthController = (await import('../../src/backend/auth/policies/authController.mjs')).default;
      mockAuthController.login.mockImplementation((req, res) => {
        res.status(200).json(mockLoginResponse);
      });

      const response = await request(app)
        .post('/auth/login')
        .send({ username: 'testuser', password: 'password' });

      expect(response.status).toBe(200);
      expect(response.body).toEqual(mockLoginResponse);
      expect(mockAuthController.login).toHaveBeenCalled();
    });
  });

  describe('POST /auth/logout', () => {
    it('should call the logout controller and return its response', async () => {
      const mockAuthController = (await import('../../src/backend/auth/policies/authController.mjs')).default;
      mockAuthController.logout.mockImplementation((req, res) => {
        res.status(200).json({ success: true });
      });

      const response = await request(app)
        .post('/auth/logout')
        .set('Authorization', 'Bearer test-token');

      expect(response.status).toBe(200);
      expect(response.body).toEqual({ success: true });
      expect(mockAuthController.logout).toHaveBeenCalled();
    });
  });

  describe('POST /auth/refresh', () => {
    it('should call the refreshToken controller and return its response', async () => {
      const mockRefreshResponse = { token: 'new-token' };
      const mockAuthController = (await import('../../src/backend/auth/policies/authController.mjs')).default;
      mockAuthController.refreshToken.mockImplementation((req, res) => {
        res.status(200).json(mockRefreshResponse);
      });

      const response = await request(app)
        .post('/auth/refresh')
        .send({ refreshToken: 'old-refresh-token' });

      expect(response.status).toBe(200);
      expect(response.body).toEqual(mockRefreshResponse);
      expect(mockAuthController.refreshToken).toHaveBeenCalled();
    });
  });

  describe('GET /auth/verify', () => {
    it('should call the verifyAuth controller and return its response', async () => {
      const mockVerifyResponse = { valid: true, user: { id: '123' } };
      const mockAuthController = (await import('../../src/backend/auth/policies/authController.mjs')).default;
      mockAuthController.verifyAuth.mockImplementation((req, res) => {
        res.status(200).json(mockVerifyResponse);
      });

      const response = await request(app)
        .get('/auth/verify')
        .set('Authorization', 'Bearer test-token');

      expect(response.status).toBe(200);
      expect(response.body).toEqual(mockVerifyResponse);
      expect(mockAuthController.verifyAuth).toHaveBeenCalled();
    });
  });

  describe('POST /auth/elevate', () => {
    it('should call the elevateAuth controller and return its response', async () => {
      const mockElevateResponse = { elevated: true, token: 'elevated-token' };
      const mockAuthController = (await import('../../src/backend/auth/policies/authController.mjs')).default;
      mockAuthController.elevateAuth.mockImplementation((req, res) => {
        res.status(200).json(mockElevateResponse);
      });

      const response = await request(app)
        .post('/auth/elevate')
        .set('Authorization', 'Bearer test-token')
        .send({ biometricVerification: 'test-verification' });

      expect(response.status).toBe(200);
      expect(response.body).toEqual(mockElevateResponse);
      expect(mockAuthController.elevateAuth).toHaveBeenCalled();
    });
  });
});
