{
  "$schema": "./registry.schema.json",
  "domain_id": "media.storyboard",
  "version": "1.0.0",
  "description": "Storyboard / Video Frame Evolution domain - Ordered frames with assets, durations, and renders",
  
  "repo_model": {
    "repository": "one storyboard project (e.g., product-launch-video__q3)",
    "branches": "competing directions (main, dramatic, humorous)",
    "proposal_branches": "proposal/<slug>"
  },
  
  "row_identity_key": "sequence_id",
  "row_identity_type": "uuid",
  "row_description": "Two-layer identity: sequence_id (stable) AND frame_index (display order, derived). NEVER use frame_index as row key.",
  
  "identity_rules": {
    "primary_key": "sequence_id",
    "display_order": "frame_index",
    "reorder_behavior": "Reordering changes frame_index view only; sequence_id remains stable",
    "critical_rule": "Frame moves are just view changes; identity persists"
  },
  
  "step_scope_options": {
    "default": "repo_dense_steps",
    "available": ["repo_dense_steps", "branch_dense_steps"],
    "rule": "Each frame edit/insert/reorder advances step for all visible frames"
  },
  
  "face_mapping": {
    "+X": {
      "semantic": "Output / Current Belief",
      "description": "Frame content pointer (image/description) at that step"
    },
    "-X": {
      "semantic": "Input / Dependency",
      "description": "Assets refs, prev/next transitions, required models"
    },
    "+Y": {
      "semantic": "Semantic Meaning",
      "description": "Scene intent (e.g., 'hero reveal 3s')"
    },
    "-Y": {
      "semantic": "Magnitude / Confidence",
      "description": "Review status %, audience score, render confidence"
    },
    "+Z": {
      "semantic": "Identity & Lineage",
      "description": "sequence_id, step, editor, commit hash"
    },
    "-Z": {
      "semantic": "Root Evidence Pointer",
      "description": "Original brief/script contract (T0)"
    }
  },
  
  "sheet_schema": {
    "columns": [
      {
        "id": "sequence_id",
        "label": "Sequence ID",
        "type": "uuid",
        "editability": "read_only",
        "visibility": "audit_view_only",
        "projection_rule": "state/frames/<id>.yaml:sequence_id",
        "commit_rule": "none"
      },
      {
        "id": "frame_index",
        "label": "Frame #",
        "type": "int",
        "editability": "computed",
        "projection_rule": "derived from frame order in state",
        "commit_rule": "none",
        "note": "Display order only; not the identity key"
      },
      {
        "id": "duration_s",
        "label": "Duration (s)",
        "type": "float",
        "editability": "editable",
        "projection_rule": "state/frames/<id>.yaml:duration",
        "commit_rule": "CELL_EDIT",
        "validation": "must be >= 0"
      },
      {
        "id": "description",
        "label": "Description",
        "type": "text",
        "editability": "editable",
        "projection_rule": "state/frames/<id>.yaml:description",
        "commit_rule": "CELL_EDIT"
      },
      {
        "id": "assets",
        "label": "Assets",
        "type": "list_of_refs",
        "editability": "editable",
        "projection_rule": "state/frames/<id>.yaml:assets[]",
        "commit_rule": "ATTACHMENT_ADD (when adding) / CELL_EDIT (when editing list)"
      },
      {
        "id": "notes",
        "label": "Notes",
        "type": "text",
        "editability": "editable",
        "projection_rule": "state/frames/<id>.yaml:notes",
        "commit_rule": "CELL_EDIT"
      },
      {
        "id": "review_status",
        "label": "Review Status",
        "type": "enum",
        "enum_values": ["draft", "review", "approved", "rejected"],
        "editability": "editable_with_gates",
        "projection_rule": "state/frames/<id>.yaml:review_status",
        "commit_rule": "CELL_EDIT"
      },
      {
        "id": "derived_render",
        "label": "Rendered Output",
        "type": "derived_ref",
        "editability": "read_only",
        "projection_rule": "pointer to derived/step-N/frame-<seq>.png or .mp4",
        "commit_rule": "none"
      },
      {
        "id": "root_brief",
        "label": "Original Brief",
        "type": "evidence_ref",
        "editability": "read_only",
        "projection_rule": "pointer to T0 brief/script",
        "commit_rule": "none"
      }
    ],
    
    "views": {
      "timeline": {
        "columns": ["frame_index", "duration_s", "description", "review_status"],
        "sort_by": "frame_index",
        "sort_order": "asc"
      },
      "production": {
        "columns": ["frame_index", "assets", "derived_render", "review_status"],
        "sort_by": "frame_index",
        "sort_order": "asc"
      },
      "script": {
        "columns": ["frame_index", "description", "notes"],
        "sort_by": "frame_index",
        "sort_order": "asc"
      },
      "audit": {
        "columns": ["sequence_id", "frame_index", "last_change_step", "root_brief"],
        "sort_by": "sequence_id",
        "sort_order": "asc"
      }
    },
    
    "operators": [
      {
        "id": "edit_cell",
        "label": "Edit Cell",
        "allowed_columns": ["duration_s", "description", "notes", "review_status"],
        "commit_class": "CELL_EDIT"
      },
      {
        "id": "insert_frame",
        "label": "Insert Frame",
        "params": ["at_position"],
        "commit_class": "ROW_CREATE + deterministic renumber as derived view"
      },
      {
        "id": "delete_frame",
        "label": "Delete Frame",
        "commit_class": "ROW_ARCHIVE",
        "note": "Mark archived; do not erase"
      },
      {
        "id": "reorder_frames",
        "label": "Reorder Frames",
        "params": ["move_frame_from_to"],
        "commit_class": "RANGE_EDIT",
        "note": "Must store a deterministic 'new ordering list'"
      },
      {
        "id": "upload_asset",
        "label": "Upload Asset",
        "commit_class": "ATTACHMENT_ADD",
        "stores": "asset file + writes ref to assets list"
      },
      {
        "id": "generate_render",
        "label": "Generate Render",
        "params": ["frame_range"],
        "commit_class": "OPERATOR_RUN",
        "generates": "derived/step-N/frame-<seq>.png or .mp4"
      },
      {
        "id": "merge_branch",
        "label": "Merge Branch",
        "commit_class": "OPERATOR_RUN",
        "role_gate": "approval_required"
      }
    ],
    
    "validation_rules": [
      {
        "field": "duration_s",
        "rule": "min_value",
        "min": 0,
        "error": "Duration must be >= 0"
      },
      {
        "field": "reorder",
        "rule": "valid_sequence_ids",
        "error": "Reorder must reference existing sequence_ids only"
      },
      {
        "field": "review_status",
        "rule": "immutability",
        "condition": "review_status === 'approved'",
        "action": "require_new_branch_or_proposal",
        "error": "Approved frames immutable unless new branch/proposal"
      }
    ]
  },
  
  "branch_compare": {
    "layout": "sequence_aligned",
    "diff_rules": {
      "matching": "match_by_sequence_id (not frame_index)",
      "moved_frames": "show as 'position changed'",
      "new_frames": "highlight as insertions",
      "deleted_frames": "highlight as archived"
    },
    "merge_ui": {
      "accept_reorder_set": true,
      "accept_per_frame_edits": true,
      "reject_or_keep_branch_frames": true
    }
  },
  
  "hooks": {
    "pre_commit": {
      "path": ".relay/pre-commit.mjs",
      "validates": [
        "duration >= 0",
        "reorder references valid sequence_ids",
        "approved frames immutable unless proposal",
        "asset uploads include hash/metadata"
      ]
    },
    "query": {
      "path": ".relay/query.mjs",
      "endpoints": [
        {
          "route": "/frame_list",
          "params": ["branch=...", "step=S"]
        },
        {
          "route": "/diff_sequence",
          "params": ["base=...", "other=..."]
        },
        {
          "route": "/render_status",
          "params": ["range=..."]
        }
      ]
    },
    "get": {
      "path": ".relay/get.mjs",
      "endpoints": [
        {
          "route": "/sheet/timeline",
          "params": ["branch=..."]
        },
        {
          "route": "/inspector/frame",
          "params": ["step=S", "sequence_id=..."]
        }
      ]
    }
  },
  
  "commit_classes": {
    "CELL_EDIT": {
      "description": "Edit duration/description/notes/status",
      "metadata_required": ["sequence_id", "colId", "before", "after"]
    },
    "ROW_CREATE": {
      "description": "Insert frame at position + deterministic renumber",
      "metadata_required": ["new_sequence_id", "insert_position", "initial_state"],
      "note": "frame_index regenerated for all frames as derived view"
    },
    "ROW_ARCHIVE": {
      "description": "Mark frame as archived (do not erase)",
      "metadata_required": ["sequence_id", "reason"]
    },
    "RANGE_EDIT": {
      "description": "Reorder frames (store new ordering list)",
      "metadata_required": ["sequence_id_order[]"],
      "note": "Deterministic reordering; frame_index regenerated"
    },
    "ATTACHMENT_ADD": {
      "description": "Upload asset (stores asset, writes ref)",
      "metadata_required": ["asset_hash", "storage_path", "type", "step_linkage"]
    },
    "OPERATOR_RUN": {
      "description": "Generate render (per frame or range)",
      "subtypes": ["generate_render", "merge_branch"],
      "metadata_required": ["operator_id", "inputs", "params"]
    }
  },
  
  "derived_artifacts": {
    "description": "Rendered frames are derived artifacts (immutable outputs of specific steps)",
    "storage_path": "derived/step-{N}/frame-{sequence_id}.{ext}",
    "required_metadata": [
      "source_assets_hashes",
      "render_params",
      "timestamp",
      "reproducibility_info"
    ],
    "formats": ["png", "jpg", "mp4", "webm"]
  }
}

