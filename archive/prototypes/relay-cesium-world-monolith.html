<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåç Relay Cesium World - Unified Application</title>
    
    <!-- Cesium CSS -->
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.113/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    
    <!-- XLSX for Excel import -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            overflow: hidden;
        }
        
        #cesiumContainer {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        /* Drop zone overlay */
        #dropZone {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 40px 60px;
            background: rgba(20, 20, 30, 0.95);
            border: 2px dashed #00ddff;
            border-radius: 12px;
            text-align: center;
            pointer-events: none;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        #dropZone.active {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
        }
        
        #dropZone.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        #dropZone h2 {
            margin-bottom: 10px;
            color: #00ddff;
        }
        
        /* HUD overlay */
        #hud {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(10, 10, 15, 0.85);
            padding: 16px 20px;
            border-radius: 8px;
            border: 1px solid rgba(0, 221, 255, 0.3);
            font-size: 13px;
            line-height: 1.6;
            z-index: 100;
            min-width: 280px;
        }
        
        #hud .status-line {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
        }
        
        #hud .label {
            color: #00ddff;
            margin-right: 10px;
        }
        
        #hud .value {
            color: #ffffff;
            font-weight: 500;
        }
        
        /* Info panel */
        #infoPanel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(10, 10, 15, 0.9);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid rgba(0, 221, 255, 0.3);
            max-width: 350px;
            z-index: 100;
            display: none;
        }
        
        #infoPanel.visible {
            display: block;
        }
        
        #infoPanel h3 {
            margin: 0 0 10px 0;
            color: #00ddff;
            font-size: 16px;
        }
        
        #infoPanel .info-row {
            margin: 8px 0;
            font-size: 13px;
        }
        
        /* Loading indicator */
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(10, 10, 15, 0.95);
            padding: 30px 50px;
            border-radius: 8px;
            text-align: center;
            z-index: 2000;
        }
        
        #loading.hidden {
            display: none;
        }
        
        .spinner {
            border: 3px solid rgba(0, 221, 255, 0.2);
            border-top: 3px solid #00ddff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Log console */
        #logConsole {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(10, 10, 15, 0.9);
            padding: 12px;
            border-radius: 6px;
            border: 1px solid rgba(0, 221, 255, 0.3);
            max-width: 600px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            z-index: 100;
            display: none;
        }
        
        #logConsole.visible {
            display: block;
        }
        
        #logConsole .log-entry {
            margin: 2px 0;
            padding: 2px 4px;
        }
        
        #logConsole .log-info { color: #00ddff; }
        #logConsole .log-success { color: #00ff88; }
        #logConsole .log-warn { color: #ffaa00; }
        #logConsole .log-error { color: #ff4444; }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>
    
    <!-- Drop Zone -->
    <div id="dropZone" class="hidden">
        <h2>üìÇ Drop Excel File</h2>
        <p>Drop an .xlsx file to import and visualize</p>
    </div>
    
    <!-- Loading Indicator -->
    <div id="loading">
        <div class="spinner"></div>
        <div>Initializing Relay Cesium World...</div>
    </div>
    
    <!-- HUD -->
    <div id="hud">
        <div style="font-weight: 600; margin-bottom: 10px; color: #00ff88;">üåç RELAY CESIUM WORLD</div>
        <div class="status-line">
            <span class="label">Status:</span>
            <span class="value" id="hudStatus">Initializing...</span>
        </div>
        <div class="status-line">
            <span class="label">LOD Level:</span>
            <span class="value" id="hudLOD">‚Äî</span>
        </div>
        <div class="status-line">
            <span class="label">Camera Height:</span>
            <span class="value" id="hudHeight">‚Äî</span>
        </div>
        <div class="status-line">
            <span class="label">Filaments:</span>
            <span class="value" id="hudFilaments">0</span>
        </div>
        <div class="status-line">
            <span class="label">Sheets:</span>
            <span class="value" id="hudSheets">0</span>
        </div>
        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0,221,255,0.2); font-size: 11px; color: #aaa;">
            Phase 0: Cesium Base ‚úÖ<br>
            Phase 1: Filaments üîÑ<br>
            Phase 2: LOD Governor üîÑ
        </div>
    </div>
    
    <!-- Info Panel -->
    <div id="infoPanel">
        <h3 id="infoPanelTitle">Object Info</h3>
        <div id="infoPanelContent"></div>
    </div>
    
    <!-- Log Console -->
    <div id="logConsole"></div>
    
    <!-- Cesium JS -->
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.113/Build/Cesium/Cesium.js"></script>
    
    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // RELAY CESIUM WORLD - UNIFIED APPLICATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Architecture: Cesium-first, one scene graph, renderer-agnostic state
        // Phase 0: Restore Cesium base (terrain + imagery + buildings)
        // Phase 1: Port filaments to Cesium primitives
        // Phase 2: Implement LOD Governor with hysteresis
        // Phase 3: Boundaries + containsLL
        // Phase 4: Votes + Weather overlays
        // Phase 5: Picking & interaction
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        console.log('[Relay] üöÄ Cesium World initializing...');
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // RELAY STATE (Renderer-Agnostic Pure Data)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const relayState = {
            tree: {
                nodes: [],
                edges: []
            },
            boundaries: [],
            votes: [],
            weather: null,
            metadata: {
                importedFile: null,
                importTimestamp: null
            }
        };
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // LOGGING SYSTEM
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const RelayLog = {
            entries: [],
            maxEntries: 100,
            
            log(message, type = 'info') {
                const entry = { message, type, timestamp: Date.now() };
                this.entries.push(entry);
                if (this.entries.length > this.maxEntries) {
                    this.entries.shift();
                }
                
                console.log(`[Relay] ${message}`);
                this.updateUI();
            },
            
            info(msg) { this.log(msg, 'info'); },
            success(msg) { this.log(msg, 'success'); },
            warn(msg) { this.log(msg, 'warn'); },
            error(msg) { this.log(msg, 'error'); },
            
            updateUI() {
                const logConsole = document.getElementById('logConsole');
                if (logConsole) {
                    logConsole.innerHTML = this.entries
                        .slice(-20)
                        .map(e => `<div class="log-entry log-${e.type}">[${new Date(e.timestamp).toLocaleTimeString()}] ${e.message}</div>`)
                        .join('');
                    logConsole.scrollTop = logConsole.scrollHeight;
                }
            },
            
            toggle() {
                const logConsole = document.getElementById('logConsole');
                logConsole.classList.toggle('visible');
            }
        };
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PHASE 0: CESIUM VIEWER INITIALIZATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        // Cesium Ion access token (use default for now, can be customized)
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJlYWE1OWUxNy1mMWZiLTQzYjYtYTQ0OS1kMWFjYmFkNjc5YzciLCJpZCI6NTc3MzMsImlhdCI6MTYyNzg0NTE4Mn0.XcKpgANiY19MC4bdFUXMVEBToBmqS8kuYpUlxJHYZxk';
        
        let viewer = null;
        let lodGovernor = null;
        let filamentRenderer = null;
        
        async function initializeCesiumViewer() {
            try {
                RelayLog.info('üåç Initializing Cesium Viewer...');
                
                viewer = new Cesium.Viewer('cesiumContainer', {
                    // Terrain
                    terrainProvider: await Cesium.createWorldTerrainAsync(),
                    
                    // Imagery
                    imageryProvider: new Cesium.IonImageryProvider({ assetId: 2 }), // Bing Maps Aerial
                    
                    // UI elements (minimal for clean interface)
                    baseLayerPicker: false,
                    geocoder: false,
                    homeButton: true,
                    sceneModePicker: false,
                    navigationHelpButton: false,
                    animation: false,
                    timeline: false,
                    fullscreenButton: false,
                    vrButton: false,
                    infoBox: false,
                    selectionIndicator: false,
                    
                    // Performance
                    requestRenderMode: false, // Continuous rendering for smooth interaction
                    maximumRenderTimeChange: Infinity
                });
                
                // Enable depth testing
                viewer.scene.globe.depthTestAgainstTerrain = true;
                
                // Add 3D Buildings (OSM Buildings via Cesium Ion)
                RelayLog.info('üè¢ Adding 3D Buildings...');
                const osmBuildings = await Cesium.createOsmBuildingsAsync();
                viewer.scene.primitives.add(osmBuildings);
                
                // Configure camera
                viewer.camera.flyTo({
                    destination: Cesium.Cartesian3.fromDegrees(34.7818, 32.0853, 15000), // Tel Aviv, 15km altitude
                    orientation: {
                        heading: 0.0,
                        pitch: Cesium.Math.toRadians(-45),
                        roll: 0.0
                    },
                    duration: 3.0
                });
                
                // Enable fog for atmospheric effect
                viewer.scene.fog.enabled = true;
                viewer.scene.fog.density = 0.0002;
                
                // Enable lighting
                viewer.scene.globe.enableLighting = true;
                
                RelayLog.success('‚úÖ Cesium Viewer initialized successfully');
                updateHUD('status', 'Ready');
                
                // Hide loading indicator
                document.getElementById('loading').classList.add('hidden');
                
                // Show drop zone
                document.getElementById('dropZone').classList.remove('hidden');
                
                return viewer;
                
            } catch (error) {
                RelayLog.error(`‚ùå Failed to initialize Cesium: ${error.message}`);
                console.error(error);
                throw error;
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PHASE 2: LOD GOVERNOR (Hysteresis-Based)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        class RelayLODGovernor {
            constructor(cesiumViewer) {
                this.viewer = cesiumViewer;
                this.currentLevel = null;
                this.subscribers = [];
                
                // LOD thresholds with hysteresis (switch in/out at different heights)
                this.thresholds = {
                    LANIAKEA: { in: 400000, out: 450000 },      // >400km ‚Üí in, <450km ‚Üí out
                    PLANETARY: { in: 100000, out: 120000 },     // >100km ‚Üí in, <120km ‚Üí out
                    REGION: { in: 50000, out: 60000 },          // >50km ‚Üí in, <60km ‚Üí out
                    COMPANY: { in: 15000, out: 18000 },         // >15km ‚Üí in, <18km ‚Üí out
                    SHEET: { in: 5000, out: 6000 },             // >5km ‚Üí in, <6km ‚Üí out
                    CELL: { in: 0, out: 0 }                     // <5km always
                };
                
                RelayLog.info('üìä LOD Governor initialized');
            }
            
            subscribe(callback) {
                this.subscribers.push(callback);
            }
            
            getCameraHeightAboveGround() {
                const camera = this.viewer.camera;
                const cartographic = Cesium.Cartographic.fromCartesian(camera.position);
                const height = cartographic.height;
                
                // Get terrain height at camera position (approximate)
                const terrainHeight = this.viewer.scene.globe.getHeight(cartographic) || 0;
                
                return height - terrainHeight;
            }
            
            determineLODLevel(height) {
                const current = this.currentLevel;
                
                // Use hysteresis: different thresholds for switching in vs out
                if (height > this.thresholds.LANIAKEA.in) {
                    return 'LANIAKEA';
                } else if (height > this.thresholds.PLANETARY.in && 
                           (current !== 'LANIAKEA' || height < this.thresholds.LANIAKEA.out)) {
                    return 'PLANETARY';
                } else if (height > this.thresholds.REGION.in && 
                           (current !== 'PLANETARY' || height < this.thresholds.PLANETARY.out)) {
                    return 'REGION';
                } else if (height > this.thresholds.COMPANY.in && 
                           (current !== 'REGION' || height < this.thresholds.REGION.out)) {
                    return 'COMPANY';
                } else if (height > this.thresholds.SHEET.in && 
                           (current !== 'COMPANY' || height < this.thresholds.COMPANY.out)) {
                    return 'SHEET';
                } else {
                    return 'CELL';
                }
            }
            
            update() {
                const height = this.getCameraHeightAboveGround();
                const newLevel = this.determineLODLevel(height);
                
                if (newLevel !== this.currentLevel) {
                    RelayLog.info(`üìä LOD switch: ${this.currentLevel || 'null'} ‚Üí ${newLevel} (height: ${Math.round(height)}m)`);
                    this.currentLevel = newLevel;
                    
                    // Notify all subscribers
                    this.subscribers.forEach(callback => {
                        try {
                            callback(newLevel, height);
                        } catch (error) {
                            RelayLog.error(`LOD subscriber error: ${error.message}`);
                        }
                    });
                    
                    // Update HUD
                    updateHUD('lod', newLevel);
                }
                
                // Always update height display
                updateHUD('height', `${Math.round(height / 1000)}km`);
            }
            
            startMonitoring() {
                // Update LOD on camera move end
                this.viewer.camera.moveEnd.addEventListener(() => {
                    this.update();
                });
                
                // Initial update
                this.update();
                
                RelayLog.success('‚úÖ LOD Governor monitoring started');
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // HUD MANAGEMENT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function updateHUD(field, value) {
            const elementMap = {
                'status': 'hudStatus',
                'lod': 'hudLOD',
                'height': 'hudHeight',
                'filaments': 'hudFilaments',
                'sheets': 'hudSheets'
            };
            
            const elementId = elementMap[field];
            if (elementId) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = value;
                }
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // FILE IMPORT SYSTEM
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function setupDragAndDrop() {
            const dropZone = document.getElementById('dropZone');
            const cesiumContainer = document.getElementById('cesiumContainer');
            
            // Prevent default drag behaviors
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                document.body.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            // Highlight drop zone when file is dragged over
            ['dragenter', 'dragover'].forEach(eventName => {
                document.body.addEventListener(eventName, () => {
                    dropZone.classList.remove('hidden');
                    dropZone.classList.add('active');
                }, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                document.body.addEventListener(eventName, () => {
                    dropZone.classList.remove('active');
                }, false);
            });
            
            // Handle dropped files
            document.body.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            }
        }
        
        async function handleFile(file) {
            try {
                RelayLog.info(`üìÇ Processing file: ${file.name}`);
                document.getElementById('dropZone').classList.add('hidden');
                document.getElementById('loading').classList.remove('hidden');
                document.getElementById('loading').querySelector('div:last-child').textContent = 'Processing file...';
                
                const reader = new FileReader();
                
                reader.onload = async (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        RelayLog.info(`üìä Workbook loaded: ${workbook.SheetNames.length} sheets`);
                        
                        // Convert first sheet to data
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        RelayLog.info(`üìÑ Sheet "${firstSheetName}": ${jsonData.length} rows`);
                        
                        // Store in relay state
                        relayState.metadata.importedFile = file.name;
                        relayState.metadata.importTimestamp = Date.now();
                        
                        // Create a simple tree structure from the data
                        createTreeFromData(firstSheetName, jsonData);
                        
                        // Render the tree
                        await renderTreeStructure();
                        
                        document.getElementById('loading').classList.add('hidden');
                        RelayLog.success(`‚úÖ File imported: ${file.name}`);
                        
                    } catch (error) {
                        RelayLog.error(`‚ùå Error processing file: ${error.message}`);
                        document.getElementById('loading').classList.add('hidden');
                    }
                };
                
                reader.readAsArrayBuffer(file);
                
            } catch (error) {
                RelayLog.error(`‚ùå Error handling file: ${error.message}`);
                document.getElementById('loading').classList.add('hidden');
            }
        }
        
        function createTreeFromData(sheetName, data) {
            // Simple tree structure: trunk ‚Üí branch ‚Üí sheet
            const trunkId = 'trunk.main';
            const branchId = 'branch.finance';
            const sheetId = `sheet.${sheetName.toLowerCase().replace(/\s+/g, '_')}`;
            
            // Anchor at Tel Aviv
            const anchor = { lat: 32.0853, lon: 34.7818, alt: 0 };
            
            relayState.tree.nodes = [
                {
                    id: trunkId,
                    type: 'trunk',
                    label: 'Main Trunk',
                    anchor: anchor,
                    children: [branchId]
                },
                {
                    id: branchId,
                    type: 'branch',
                    label: 'Finance Branch',
                    parent: trunkId,
                    anchor: { ...anchor, alt: 100 },
                    children: [sheetId]
                },
                {
                    id: sheetId,
                    type: 'sheet',
                    label: sheetName,
                    parent: branchId,
                    anchor: { ...anchor, alt: 150 },
                    data: data,
                    children: []
                }
            ];
            
            RelayLog.info(`üå≥ Tree structure created: ${relayState.tree.nodes.length} nodes`);
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PHASE 1: FILAMENT RENDERER (Cesium Primitives)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        class CesiumFilamentRenderer {
            constructor(cesiumViewer) {
                this.viewer = cesiumViewer;
                this.primitives = [];
                this.entities = [];
                
                RelayLog.info('üß¨ Filament Renderer initialized');
            }
            
            clear() {
                // Remove all primitives
                this.primitives.forEach(p => {
                    this.viewer.scene.primitives.remove(p);
                });
                this.primitives = [];
                
                // Remove all entities
                this.entities.forEach(e => {
                    this.viewer.entities.remove(e);
                });
                this.entities = [];
            }
            
            renderTree(relayState) {
                this.clear();
                
                const nodes = relayState.tree.nodes;
                
                nodes.forEach(node => {
                    switch (node.type) {
                        case 'trunk':
                            this.renderTrunk(node);
                            break;
                        case 'branch':
                            this.renderBranch(node);
                            break;
                        case 'sheet':
                            this.renderSheet(node);
                            break;
                    }
                });
                
                updateHUD('filaments', this.primitives.length);
                updateHUD('sheets', nodes.filter(n => n.type === 'sheet').length);
                
                RelayLog.success(`‚úÖ Rendered ${this.primitives.length} primitives`);
            }
            
            renderTrunk(node) {
                // Trunk as a simple marker for now
                const position = Cesium.Cartesian3.fromDegrees(
                    node.anchor.lon,
                    node.anchor.lat,
                    node.anchor.alt
                );
                
                const entity = this.viewer.entities.add({
                    position: position,
                    point: {
                        pixelSize: 15,
                        color: Cesium.Color.fromCssColorString('#00ff88').withAlpha(0.9),
                        outlineColor: Cesium.Color.WHITE,
                        outlineWidth: 2
                    },
                    label: {
                        text: node.label,
                        font: '14pt sans-serif',
                        fillColor: Cesium.Color.WHITE,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 2,
                        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                        pixelOffset: new Cesium.Cartesian2(0, -20)
                    }
                });
                
                this.entities.push(entity);
            }
            
            renderBranch(node) {
                // Branch as a polyline from trunk to branch position
                const parent = relayState.tree.nodes.find(n => n.id === node.parent);
                if (!parent) return;
                
                const startPos = Cesium.Cartesian3.fromDegrees(
                    parent.anchor.lon,
                    parent.anchor.lat,
                    parent.anchor.alt
                );
                
                const endPos = Cesium.Cartesian3.fromDegrees(
                    node.anchor.lon,
                    node.anchor.lat,
                    node.anchor.alt
                );
                
                // Create a curved path (simple arc for now)
                const positions = this.createArcPositions(startPos, endPos, 10);
                
                const entity = this.viewer.entities.add({
                    polyline: {
                        positions: positions,
                        width: 5,
                        material: new Cesium.PolylineGlowMaterialProperty({
                            glowPower: 0.2,
                            color: Cesium.Color.fromCssColorString('#00ddff').withAlpha(0.7)
                        })
                    }
                });
                
                this.entities.push(entity);
                
                // Add branch endpoint marker
                const branchMarker = this.viewer.entities.add({
                    position: endPos,
                    point: {
                        pixelSize: 10,
                        color: Cesium.Color.fromCssColorString('#00ddff').withAlpha(0.8),
                        outlineColor: Cesium.Color.WHITE,
                        outlineWidth: 1
                    },
                    label: {
                        text: node.label,
                        font: '12pt sans-serif',
                        fillColor: Cesium.Color.WHITE,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 2,
                        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                        pixelOffset: new Cesium.Cartesian2(0, -15)
                    }
                });
                
                this.entities.push(branchMarker);
            }
            
            renderSheet(node) {
                // Sheet as a plane (rectangle) at the branch endpoint
                const position = Cesium.Cartesian3.fromDegrees(
                    node.anchor.lon,
                    node.anchor.lat,
                    node.anchor.alt
                );
                
                // Create a simple plane using Cesium.Plane and a rectangle
                const entity = this.viewer.entities.add({
                    position: position,
                    plane: {
                        plane: new Cesium.Plane(Cesium.Cartesian3.UNIT_Z, 0.0),
                        dimensions: new Cesium.Cartesian2(50.0, 60.0), // 50m x 60m
                        material: Cesium.Color.fromCssColorString('#00aaff').withAlpha(0.3),
                        outline: true,
                        outlineColor: Cesium.Color.fromCssColorString('#00ddff')
                    },
                    label: {
                        text: node.label,
                        font: '14pt sans-serif',
                        fillColor: Cesium.Color.WHITE,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 2,
                        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                        pixelOffset: new Cesium.Cartesian2(0, -30)
                    }
                });
                
                this.entities.push(entity);
            }
            
            createArcPositions(start, end, numPoints) {
                const positions = [];
                for (let i = 0; i <= numPoints; i++) {
                    const t = i / numPoints;
                    const position = new Cesium.Cartesian3();
                    Cesium.Cartesian3.lerp(start, end, t, position);
                    
                    // Add slight upward arc
                    const midHeight = Cesium.Cartesian3.distance(start, end) * 0.1;
                    const arcHeight = Math.sin(t * Math.PI) * midHeight;
                    const up = Cesium.Cartesian3.normalize(position, new Cesium.Cartesian3());
                    Cesium.Cartesian3.multiplyByScalar(up, arcHeight, up);
                    Cesium.Cartesian3.add(position, up, position);
                    
                    positions.push(position);
                }
                return positions;
            }
        }
        
        async function renderTreeStructure() {
            if (!filamentRenderer) {
                filamentRenderer = new CesiumFilamentRenderer(viewer);
            }
            
            filamentRenderer.renderTree(relayState);
            
            // Fly to the tree
            const firstNode = relayState.tree.nodes[0];
            if (firstNode) {
                viewer.camera.flyTo({
                    destination: Cesium.Cartesian3.fromDegrees(
                        firstNode.anchor.lon,
                        firstNode.anchor.lat,
                        5000 // 5km altitude for good view
                    ),
                    orientation: {
                        heading: 0.0,
                        pitch: Cesium.Math.toRadians(-45),
                        roll: 0.0
                    },
                    duration: 3.0
                });
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // KEYBOARD SHORTCUTS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        document.addEventListener('keydown', (e) => {
            switch(e.key.toLowerCase()) {
                case 'l':
                    RelayLog.toggle();
                    break;
                case 'h':
                    document.getElementById('hud').style.display = 
                        document.getElementById('hud').style.display === 'none' ? 'block' : 'none';
                    break;
                case 'i':
                    console.log('[Relay] State:', relayState);
                    console.log('[Relay] Viewer:', viewer);
                    if (lodGovernor) {
                        console.log('[Relay] LOD Level:', lodGovernor.currentLevel);
                        console.log('[Relay] Camera Height:', lodGovernor.getCameraHeightAboveGround());
                    }
                    break;
            }
        });
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // INITIALIZATION SEQUENCE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        async function initialize() {
            try {
                // Phase 0: Initialize Cesium Viewer
                await initializeCesiumViewer();
                
                // Phase 2: Initialize LOD Governor
                lodGovernor = new RelayLODGovernor(viewer);
                lodGovernor.startMonitoring();
                
                // Subscribe LOD updates
                lodGovernor.subscribe((level, height) => {
                    RelayLog.info(`üìä LOD Level: ${level} at ${Math.round(height)}m`);
                    // Future: trigger renderer detail changes based on level
                });
                
                // Setup drag and drop
                setupDragAndDrop();
                
                RelayLog.success('‚úÖ Relay Cesium World initialized successfully');
                RelayLog.info('üí° Shortcuts: L=Logs, H=HUD, I=Inspector');
                RelayLog.info('üìÇ Drag & drop an Excel file to import');
                
            } catch (error) {
                RelayLog.error(`‚ùå Initialization failed: ${error.message}`);
                console.error(error);
            }
        }
        
        // Start initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initialize);
        } else {
            initialize();
        }
    </script>
</body>
</html>
