<!DOCTYPE html>
<html>
<head>
    <title>Vote Change Verification</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .transaction { 
            border: 1px solid #ccc; 
            margin: 10px 0; 
            padding: 10px; 
            background: #f9f9f9; 
        }
        .vote-switch { background: #ffffcc; border-color: #ffcc00; }
        .initial-vote { background: #ccffcc; border-color: #00cc00; }
        .summary { 
            background: #e6f3ff; 
            border: 2px solid #0066cc; 
            padding: 15px; 
            margin-bottom: 20px; 
        }
    </style>
</head>
<body>
    <h1>Vote Change Verification</h1>
    <div id="summary" class="summary">Loading verification...</div>
    <div id="transactions"></div>
    
    <script>
        async function verifyVoteChanges() {
            const summaryDiv = document.getElementById('summary');
            const transactionsDiv = document.getElementById('transactions');
            
            try {
                // Get test data transactions
                const response = await fetch('/api/vote/debug/test-data');
                const data = await response.json();
                
                const transactions = data.data?.testTransactions || [];
                const frontendVotes = transactions.filter(t => 
                    t.data?.testDataSource === 'frontend_submission'
                ).sort((a, b) => a.timestamp - b.timestamp);
                
                // Analyze vote pattern
                let voteSequence = [];
                let voteSwitches = 0;
                let initialVotes = 0;
                
                frontendVotes.forEach(tx => {
                    const candidateId = tx.data?.candidateId;
                    const switched = tx.data?.switched;
                    const previousCandidate = tx.data?.previousCandidate;
                    const timestamp = new Date(tx.timestamp).toLocaleString();
                    
                    voteSequence.push({
                        candidate: candidateId,
                        switched: switched,
                        previous: previousCandidate,
                        timestamp: timestamp,
                        transaction: tx
                    });
                    
                    if (switched) {
                        voteSwitches++;
                    } else {
                        initialVotes++;
                    }
                });
                
                // Display summary
                summaryDiv.innerHTML = `
                    <h2>Vote Change Analysis</h2>
                    <p><strong>Total frontend vote transactions:</strong> ${frontendVotes.length}</p>
                    <p><strong>Initial votes:</strong> ${initialVotes}</p>
                    <p><strong>Vote switches:</strong> ${voteSwitches}</p>
                    <p><strong>Vote sequence:</strong> ${voteSequence.map(v => v.candidate).join(' → ')}</p>
                    <p><strong>Status:</strong> ${frontendVotes.length > 0 ? '✅ Votes recorded in blockchain' : '❌ No votes found'}</p>
                `;
                
                // Display detailed transactions
                transactionsDiv.innerHTML = '<h2>Detailed Vote Transactions</h2>';
                
                voteSequence.forEach((vote, index) => {
                    const div = document.createElement('div');
                    div.className = `transaction ${vote.switched ? 'vote-switch' : 'initial-vote'}`;
                    
                    div.innerHTML = `
                        <h3>Transaction ${index + 1} - ${vote.switched ? 'VOTE SWITCH' : 'INITIAL VOTE'}</h3>
                        <p><strong>Candidate:</strong> ${vote.candidate}</p>
                        <p><strong>Timestamp:</strong> ${vote.timestamp}</p>
                        <p><strong>Vote Switch:</strong> ${vote.switched ? 'Yes' : 'No'}</p>
                        ${vote.previous ? `<p><strong>Previous Candidate:</strong> ${vote.previous}</p>` : ''}
                        <p><strong>User ID:</strong> ${vote.transaction.data?.userId}</p>
                        <p><strong>Transaction Hash:</strong> ${vote.transaction.hash}</p>
                        <details>
                            <summary>Full Transaction Data</summary>
                            <pre>${JSON.stringify(vote.transaction, null, 2)}</pre>
                        </details>
                    `;
                    
                    transactionsDiv.appendChild(div);
                });
                
                // Verify the specific sequence from logs
                const expectedSequence = ['ronikatz228', 'oriazoulay768', 'ronikatz228'];
                const actualSequence = voteSequence.map(v => v.candidate);
                
                const sequenceMatch = JSON.stringify(actualSequence.slice(-3)) === JSON.stringify(expectedSequence);
                
                if (sequenceMatch) {
                    summaryDiv.innerHTML += `
                        <div style="background: #ccffcc; padding: 10px; margin-top: 10px; border: 2px solid #00cc00;">
                            <strong>✅ VERIFICATION SUCCESS:</strong> The vote sequence matches the frontend logs exactly!<br>
                            Expected: ${expectedSequence.join(' → ')}<br>
                            Actual: ${actualSequence.slice(-3).join(' → ')}
                        </div>
                    `;
                } else {
                    summaryDiv.innerHTML += `
                        <div style="background: #ffcccc; padding: 10px; margin-top: 10px; border: 2px solid #cc0000;">
                            <strong>❌ VERIFICATION ISSUE:</strong> Vote sequence doesn't match logs<br>
                            Expected: ${expectedSequence.join(' → ')}<br>
                            Actual: ${actualSequence.join(' → ')}
                        </div>
                    `;
                }
                
            } catch (error) {
                summaryDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }
        
        // Run verification on page load
        window.onload = verifyVoteChanges;
    </script>
</body>
</html>
