//backend/state/blockchain.mjs
import crypto from 'crypto';
import fs from 'fs/promises';
import path from 'path';
import { constants } from 'fs';
import logger from '../utils/logging/logger.mjs';

// Logger for blockchain operations
const blockchainLogger = logger.child({ module: 'blockchain' });

// File to store blockchain data
const BLOCKCHAIN_FILE = path.join(process.env.DATA_DIR || './data', 'chain.jsonl');

// Import from core blockchain
import { Block, Blockchain, blockchain, createBlock as coreCreateBlock } from '../blockchain/blockchain.mjs';

// Re-export core components
export { Block, Blockchain, blockchain };

/**
 * Create a new block with the given data and save to state
 * @param {Object} data - Data to store in the block 
 * @returns {Block} - The created block
 */
export function createBlock(data) {
  // Use the core implementation but add state-specific processing
  const block = coreCreateBlock(data);
  
  // Add state-specific processing (like saving to disk)
  saveBlock(block).catch(err => {
    blockchainLogger.error('Failed to save block to disk', { error: err.message });
  });
  
  return block;
}

/**
 * Save a block to persistent storage
 */
async function saveBlock(block) {
  // Skip file writes in development if env variable is set
  if (process.env.SKIP_BLOCKCHAIN_WRITES === 'true') {
    return;
  }
  
  try {
    // Ensure data directory exists
    const dir = path.dirname(BLOCKCHAIN_FILE);
    try {
      await fs.access(dir, constants.F_OK);
    } catch (error) {
      await fs.mkdir(dir, { recursive: true });
    }
    
    // Append block to file
    await fs.appendFile(
      BLOCKCHAIN_FILE,
      JSON.stringify(block) + '\n',
      'utf8'
    );
  } catch (error) {
    blockchainLogger.error('Error saving block', { error: error.message });
  }
}

/**
 * Initialize blockchain with state extensions
 */
export async function initializeBlockchain() {
  blockchainLogger.info('Initializing state-specific blockchain extensions');
  return blockchain;
}